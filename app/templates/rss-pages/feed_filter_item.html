<!-- extend base layout -->
{%- extends "__base.html" -%}


{%- macro tableHeader() -%}
	<table class='table-striped table table-bordered table-condensed fullwidth' style="table-layout: fixed;">
		<colgroup>
			<col />
			<col style="width: 50%;" />
		</colgroup>
		<tr>
			<th>
				Feed name
			</th>
			<th>
				URLs
			</th>
		</tr>
{%- endmacro -%}

{%- macro tableFooter() -%}
	</table>
{%- endmacro -%}



{%- macro release_block(block_item_list) -%}
	<div>
		{{block_item_list}}
	</div>
{%- endmacro -%}




{%- block content -%}
	{%- include '_block_flash.html' -%}
	<div class="well well-large" style="min-height: 140px; width: 100%;">
		<div><h2 style='display: inline'>RSS Feed Source: {{feed.feed_name}}</h2></div>
		<div class='clearfix'></div>

		<div id="code-editor">{{feed.func}}{{"\n\n\n"}}</div>
		<button onclick="apply_function_update()" class="btn btn-primary" style='display: inline; float:right'>Update function and execute</button>
		<button onclick="discard_changes()" class="btn btn-danger">Discard changes</button>
		<div class='clearfix'></div>
		<hr>
		<div id="process-results">
			<div class="center-block text-center">
				<h4>Loading current feed items.</h4>
				<p>Please Wait.</p>
				<img src="/static/loading.gif">
				<br>
				<br>
			</div>
		</div>

	</div>

{%- endblock -%}

{%- block footer -%}
	<style type="text/css" media="screen">
		#code-editor {
			top: 0;
			right: 0;
			bottom: 0;
			left: 0;
			min-height: 100px
		}
	</style>
	<script src="/static/js/ace/ace.js" type="text/javascript" charset="utf-8"></script>
	<script>
		var editor = ace.edit("code-editor");
		editor.getSession().setUseSoftTabs(false);
		editor.setDisplayIndentGuides(true);
		editor.setShowInvisibles(true);
		editor.setTheme("ace/theme/cobalt");
		editor.getSession().setMode("ace/mode/python");
		editor.resize()
		editor.setOptions({
			autoScrollEditorIntoView: true,
			maxLines: 500
		})

		$("#process-results").load("/feed-filters/feedid-process-results/{{feedid}}")


		var csrftoken = $('meta[name=csrf-token]').attr('content')

		$.ajaxSetup({
			beforeSend: function(xhr, settings) {
				if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
					xhr.setRequestHeader("X-CSRFToken", csrftoken)
				}
			}
		})



		function new_func_apply_fail_cb(jqXHR, textStatus, errorThrown)
		{
			console.log("Apply failed callback?")
			$("#process-results").html(`
				<div class="center-block text-center">
					<h4>Error applying changes!</h4>
					<p>Error: ` + errorThrown + `</p>
					<p>Status text: ` + textStatus + `</p>
					<p>Possibly a function issue?</p>
				</div>`)
		}


		function new_func_ok_cb(data, textStatus, jqXHR)
		{
			console.log("Applied data:", data)
			console.log("error:", data.error)
			console.log("reload:", data.reload)


			if (data.error)
			{
				$("#process-results").html('<div>' + data.message + '<br><br></div>')
			}

			if (data.reload)
			{
				// If we've loaded OK, refresh the contents of the process-results div
				$("#process-results").html('<div class="center-block text-center"><h4>Loading results.</h4><p>Please Wait.</p><img src="/static/loading.gif"><br><br></div>')
				$("#process-results").load("/feed-filters/feedid-process-results/{{feedid}}")
			}
		}


		function apply_function_update()
		{
			console.log("Apply and update call!")
			$("#process-results").html('<div class="center-block text-center"><h4>Applying updated function.</h4><p>Please Wait.</p><img src="/static/loading.gif"><br><br></div>')

			var params = {
				'mode'    : 'update_feed_parse_func',
				'data'    : editor.getValue(),
				'feed_id' : {{feedid}},
			};

			console.log("Making request")
			$.ajax({
				url         : '/feed-filters/api/',
				data        : JSON.stringify(params),
				success     : new_func_ok_cb,
				error       : new_func_apply_fail_cb,
				method      : "POST",
				dataType    : 'json',
				contentType : "application/json;",

			})


		}
		function discard_changes()
		{
			console.log("Discard changes call!")
		}

	</script>
{%- endblock -%}